# 状态栏功能

[English](STATUS_BAR.md) | [中文](STATUS_BAR_zh.md)

## 概述

Mini Claude Code 现在包含一个实时状态栏，可以一目了然地显示会话的关键信息。

## 状态栏组件

状态栏显示三个关键指标：

```
┌──────────────────────────────────────────────────────────────────────────────┐
│ 🔌 MCP: 3 │ 🟢 Context: 45% │ 💬 Messages: 67                                │
└──────────────────────────────────────────────────────────────────────────────┘
```

### 1. MCP 连接状态

**图标**：🔌（已连接）或 ⚪（未连接）  
**颜色**：
- **绿色**：已连接一个或多个 MCP 服务器
- **灰色**：没有连接 MCP 服务器

**示例**：
- `🔌 MCP: 3` - 3 个 MCP 服务器已连接
- `⚪ MCP: 0` - 没有 MCP 服务器

### 2. 上下文使用率（压缩状态）

**图标和颜色**：
- 🟢 **绿色（0-74%）**：正常 - 有充足的上下文空间
- 🟡 **黄色（75-91%）**：警告 - 接近限制
- 🔴 **红色（92-100%）**：临界 - 即将触发自动压缩

**显示**：显示已使用的上下文窗口百分比

**示例**：
- `🟢 Context: 15%` - 空间充足
- `🟡 Context: 78%` - 警告阈值
- `🔴 Context: 93%` - 临界（即将自动压缩）

### 3. 消息计数

**图标**：💬  
**颜色**：青色  
**显示**：对话历史中的消息总数

**示例**：
- `💬 Messages: 45` - 历史中有 45 条消息

## 状态栏显示时机

状态栏会在以下情况显示：

1. **启动时** - 显示初始状态
2. **每个命令后** - 在 `/help`、`/stats`、`/compact` 等命令后更新
3. **AI 响应后** - 在每次对话轮次后更新
4. **特殊操作后** - 在压缩、重置等操作后更新

## 视觉示例

### 健康会话
```
┌──────────────────────────────────────────────────────────────────────────────┐
│ 🔌 MCP: 2 │ 🟢 Context: 35% │ 💬 Messages: 20                                │
└──────────────────────────────────────────────────────────────────────────────┘
```
一切正常，有充足的上下文空间。

### 警告状态
```
┌──────────────────────────────────────────────────────────────────────────────┐
│ 🔌 MCP: 2 │ 🟡 Context: 78% │ 💬 Messages: 85                                │
└──────────────────────────────────────────────────────────────────────────────┘
```
上下文使用率较高。考虑使用 `/compact` 释放空间。

### 临界状态
```
┌──────────────────────────────────────────────────────────────────────────────┐
│ 🔌 MCP: 1 │ 🔴 Context: 93% │ 💬 Messages: 120                               │
└──────────────────────────────────────────────────────────────────────────────┘
```
上下文接近满载。下次查询时将触发自动压缩。

### 无 MCP 服务器
```
┌──────────────────────────────────────────────────────────────────────────────┐
│ ⚪ MCP: 0 │ 🟢 Context: 12% │ 💬 Messages: 8                                 │
└──────────────────────────────────────────────────────────────────────────────┘
```
在没有 MCP 服务器的情况下工作（仅基础功能）。

## 响应式设计

状态栏会自动适应您的终端宽度：
- **窄终端**：内容适配并有适当的填充
- **宽终端**：扩展以填充宽度
- **最小宽度**：建议 60 字符

## 颜色编码逻辑

### 上下文使用率颜色

```
 0% ─────────────────► 74%    🟢 绿色（正常）
75% ─────────────────► 91%    🟡 黄色（警告）
92% ─────────────────► 100%   🔴 红色（临界）
```

阈值与 92% 的自动压缩触发点对齐。

## 与上下文压缩的集成

状态栏与上下文压缩无缝协作：

1. **压缩前**：在 92%+ 时显示 🔴
2. **压缩期间**：系统显示压缩进度
3. **压缩后**：状态栏显示降低的百分比和消息计数

### 示例：压缩周期

**压缩前**：
```
┌──────────────────────────────────────────────────────────────────────────────┐
│ 🔌 MCP: 2 │ 🔴 Context: 93% │ 💬 Messages: 120                               │
└──────────────────────────────────────────────────────────────────────────────┘
```

*[触发自动压缩]*

**压缩后**：
```
┌──────────────────────────────────────────────────────────────────────────────┐
│ 🔌 MCP: 2 │ 🟢 Context: 4% │ 💬 Messages: 2                                  │
└──────────────────────────────────────────────────────────────────────────────┘
```

## 测试状态栏

运行测试脚本查看所有状态：

```bash
node test-status-bar.js
```

这将演示：
- 不同的连接状态
- 所有颜色阈值
- 从 0% 到 100% 的动画进度

## 技术细节

### 实现

- **文件**：`src/utils/ui.ts`
- **函数**：`printStatusBar(mcpServerCount, contextPercent, messageCount)`
- **更新函数**：`updateStatusBar()` 用于原地更新

### 使用的终端代码

- 方框绘制字符：`┌─┐└┘│`
- ANSI 转义码用于颜色
- 基于 `process.stdout.columns` 的自动宽度计算

### 性能

- 最小开销（< 1ms 渲染）
- 无网络调用
- 仅在状态变化时更新
- 高效的终端渲染

## 提示

1. **监控上下文使用率**：注意 🟡 黄色，知道何时压缩
2. **MCP 状态**：验证您的 MCP 服务器已连接（🔌 绿色）
3. **消息计数**：一目了然地跟踪对话长度
4. **使用 /stats**：查看状态栏之外的详细上下文统计信息

## 相关命令

- `/stats` - 详细的上下文使用统计
- `/compact` - 手动上下文压缩
- `/reset` - 清除所有历史
- `/help` - 显示所有可用命令

## 故障排除

### 状态栏未显示
- 确保终端宽度至少 60 字符
- 检查输出是否指向 TTY（未被管道传输）

### MCP 计数不正确
- MCP 初始化可能失败
- 检查 `.mcp.json` 中的 MCP 配置

### 上下文百分比似乎错误
- Token 估算使用启发式算法（~0.25 tokens/字符）
- 实际使用可能变化 ±10%
- 使用 `/stats` 查看详细分析

## 未来增强

计划的改进：
- [ ] Token 速率指示器（tokens/分钟）
- [ ] 成本估算显示
- [ ] 模型指示器（哪个模型处于活动状态）
- [ ] 网络延迟指示器
- [ ] 可定制的状态栏组件

## 反馈

状态栏旨在提供一目了然的信息，而不会使界面混乱。如果您有改进建议，请开启一个 issue！

## 相关文档

- [上下文压缩功能](CONTEXT_COMPRESSION_zh.md) - 上下文管理详细指南
- [项目 README](../README_zh.md) - 主要项目文档

